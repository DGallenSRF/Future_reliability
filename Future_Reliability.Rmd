---
title: "I 494 Reliability"
output:
  html_document:
    df_print: paged
---

```{r setup,message=FALSE, include=FALSE}
knitr::opts_knit$set(root.dir = 'H:/Projects/11000/11155/TraffStudy/Reliability/Reliability_processing')

##below are a list of packages required to run the markdown file
library(tidyverse)
library(lubridate)
library(gridExtra)
library(reshape2)
library(zoo)
library(rgdal)
library(mgcv)
library(data.table)
library(plotly)
library(broom)
library(nlstools)
library(purrr)
library(flextable)
library(officer)
library(readxl)
library(DBI)
library(odbc)
library(ggthemes)
library(leaflet)
dir()
```


## LOAD DATA 


```{r read data from SQL, include = FALSE}

drv <- DBI::dbConnect(odbc(),
                      driver = 'SQL Server',
                      server = 'VS-SQL02',
                      database = 'Traffic',
                      uid = 'TrafficUser',
                      pwd = 'dubliNmusTang',
                      port = 5432)

Data_494 <- DBI::dbReadTable(drv, 'Existing494')
```


```{r fix column names, include = FALSE}

##Turn SQL time (UTC) to US/Central

Data_494$DateTime <- as.POSIXct(as.POSIXlt(Data_494$DateTime, tz = 'America/Chicago'))
```

```{r initial load of segment data in database, include=FALSE}

# path <- 'H:/Projects/11000/11155/TraffStudy/Reliability/'
# Seg <- read_xls(paste(path,
#                       'Segment_494_TableToExcel.xls',
#                       sep = ''))
# 
# Seg <- Seg %>%
#   select(everything(),Nearest_Station = `Nearest Station`) %>%
#   select(Direction, Segment_No, Segment_Location, LAT, LONG, INT, Measure_Round, Nearest_Station, Length) %>%
#   mutate(Lanes = 4,
#          Future = '-',
#          Exist_Demand = '-')
# 
# DBI::dbWriteTable(drv, 'Segments_494', Seg, overwrite = TRUE)
```

### Add variables to the existing dataset 

15 minute volume takes the VMT for each time bin and divides by the length of the segment. Unit: Vehicles per mile.
Speed is the segment length divided by the travel time ( * 60). Unit: Miles per hour.
Hourly_Flow is the 15 minute volume multipled by 4 and divided by the number of lanes. Unit: Vehicles per hour.
Density is the Hourly Flow divided by speed. Unit: Vehicles per hour.

We also create a variable that measures the delay type experienced by the segment. Weather (snow) events and crashes were tracked for the time period. If the segment experiences a weather event and a crash, weather will be the controlling delay type.


```{r add_variables, include=FALSE}

Seg <- DBI::dbReadTable(drv, 'Segments_494')

Segments_494 <-  Seg %>%  filter(!is.na(Length)) %>%
  select(Segment = Segment_No, Lanes, Length) %>%
  arrange(Segment)

Segments_494[Segments_494$Segment == 3,"Lanes"] <- 3
Segments_494[Segments_494$Segment == 6,"Lanes"] <- 3

Data_494 <- merge(Data_494, Segments_494, by = 'Segment')

Rel <- Data_494 %>% 
  mutate(Vol_15_min  = VMT_total/Length,
         Speed       = Length/TT_mean*60,
         Hourly_Flow = Vol_15_min*4/Lanes,
         Dens        = Hourly_Flow/Speed,
         Hour        = as.factor(format(DateTime,format = '%H')),
         Month       = as.factor(format(DateTime,format = '%m')),
         WeekDay     = as.factor(weekdays(DateTime)),
         DateTimeSec = as.numeric(DateTime)) %>%
  filter(!is.na(DateTime))
```


``` {r add_conditionals, include = FALSE}

test_list <- list()
result <- vector()
for (i in 1:length(Rel$weather)){
  n <- 8
  n <- ifelse(i < n, i, n)
  test_list[i] <- list(Rel$weather[i:(i-n)])
  result[i] <- ifelse(unlist(any(test_list[[i]] == 1)),1,0)
}
rm(test_list)
head(result)

Rel$weather2hour <- result

test_list <- list()
result <- vector()
for (i in 1:length(Rel$Crash)){
  n <- 4
  n <- ifelse(i < n, i, n)
  test_list[i] <- list(Rel$Crash[i:(i-n)])
  result[i] <- ifelse(unlist(any(test_list[[i]] == 1)),1,0)
}
rm(test_list)
head(result)

Rel$Crash2hour <- result

Rel <- Rel %>% 
  mutate(Delay_type  = (ifelse(weather2hour == 1, 
                               'Weather',
                               ifelse(Crash2hour == 1, 
                                      'Crash',
                                      'None'))),
         is_Delay       = ifelse(Delay_type == 'None', 
                                 'No_Delay',
                                 'Delay'),
         Index = seq(1,length(Speed),1),
         Is_weekday = ifelse(WeekDay %in% c('Monday','Tuesday','Wednesday','Thursday','Friday'),1,0))

```



Check the dataset for outliers by plottling all of the travel time obsevations for each segment. 

```{r filter for outlier, echo=FALSE}

ggplot(Rel,aes(x = as.factor(Segment),y = TT_mean)) +
  geom_boxplot(outlier.shape = NA) +
  geom_jitter(alpha = 0.5) +
  annotate('rect',xmin=8.2,xmax = 9.5,ymin = 35,ymax = 79,alpha = 0.2)+
  annotate('text',x=7.9,y=57, label = '3 outlier travel times experienced\n during crash incident',hjust = 1)

```

We see three significant outliers in Segment 9. Upon inspection of the dataset, these travel times were observed during a crash incident. 

```{r Seg 9 outliers, include=FALSE}

Rel %>%
  filter(Segment == 9) %>%
  arrange(desc(TT_mean)) %>%
  print()

```


```{r bin data, echo=FALSE, messages = FALSE}


bins <- c(seq(floor(min(Rel$Dens)),50,2),60,70,80,90,100,125,150,200,300,400,480)


#1S
# bins <- c(seq(floor(min(Rel_2014$Dens)),50,2),
#           60,70,80,100,125,150,round(max(Rel_2014$Dens)+1,0))

Rel$cut <- cut(Rel$Dens,bins,echo.lowest = TRUE)
Rel$Density_bin <- as.numeric(stringi::stri_match_last_regex(Rel$cut,'[0-9]+')) 

d <- Rel %>%
  group_by(Density_bin, Segment) %>%
  summarise(Count = n()) %>%
  arrange(Density_bin) %>%
  dcast(Density_bin ~ Segment)

d

Rel_spare <- Rel

```


### Percentile Bin and Free Flow

We will break down the dataset into each delay type and then further into percentiles. 

```{r percentiles, echo=FALSE}

p <- c(.05,.1,0.25,0.5,0.75,0.9,.95)

# p <- c(.05,.1, 0.2, .3, .4, .5, .6, .7, .8, .9, .95)

# p <- seq(0.05,0.95,0.05)
```


The percentiles choosen are `r p`.

For each quantile a travel time quantile is calculated. We also want to calculate a Free Floew Speed for each quantile. 

```{r create binned dataset, include=FALSE}

Rel_bin <- Rel %>%
  mutate(Density_bin = as.numeric(stringi::stri_match_last_regex(cut,'[0-9]+'))) %>%
  group_by(Segment,Delay_type,Density_bin) %>%
  # group_by(Delay_type,Density_bin) %>%
  summarise(quantiles = list(sprintf("%1.0f%%", p*100)),
            TT_quantile = list(quantile(TT_mean,p))) %>%
  unnest() %>%
  merge(.,Segments_494, by = 'Segment') %>%
  mutate(Speed = Length/TT_quantile*60,
         Flow = Speed * Density_bin,
         quantiles = as.factor(quantiles)) %>%
  as.data.frame()

Rel_FF <- Rel_bin %>%
  # group_by(Delay_type,quantiles) %>%
  group_by(Segment,Delay_type,quantiles) %>%
  summarise(FF_quantile = round(quantile(Flow/Density_bin,.95, na.rm = TRUE),0))


Rel_bin <- merge(Rel_bin,Rel_FF) %>%
  mutate(Index_bin = as.integer((seq(1,length(FF_quantile),1))),
         TTI = TT_quantile/(Length/FF_quantile * 60))

# Rel_bin$quantiles <- factor(Rel_bin$quantiles,levels(Rel_bin$quantiles)[c(5,1:4,6:11)])
                            
head(Rel_bin)
```

The Free Flow speeds were calcuated using the 95th percentile speeds. 


## MAP


```{r map, echo=FALSE, fig.height=2}


m <- leaflet() %>%
  addTiles() %>%
  addLabelOnlyMarkers(lng = subset(Seg, Segment_Location == 'START')$LONG,
                      lat = subset(Seg, Segment_Location == 'START')$LAT, 
                      label = paste(as.character(subset(Seg, Segment_Location == 'START')$Segment_No),
                                    substring(subset(Seg, Segment_Location == 'START')$Segment_Location,1,1)),
                      labelOptions = labelOptions(noHide = T, direction = 'top')) %>%
    addLabelOnlyMarkers(lng = subset(Seg, Segment_Location == 'END')$LONG,
                      lat = subset(Seg, Segment_Location == 'END')$LAT, 
                      label = paste(as.character(subset(Seg, Segment_Location == 'END')$Segment_No),
                                    substring(subset(Seg, Segment_Location == 'END')$Segment_Location,1,1)),
                      labelOptions = labelOptions(noHide = T, direction = 'bottom')) 

m
```

## FREE FLOW PLOTS {.tabset .tabset-fade}

```{r free flow plot, include = FALSE}
free_flow_plot <- function(seg, legend = ''){
  ff <- ggplot()+
    geom_point(data = data.frame(Rel_bin[Rel_bin$Segment == seg,]),
               aes(x=Density_bin,y=Flow, color=quantiles))+
    geom_abline(data = data.frame(Rel_FF[Rel_FF$Segment == 1,]),
                aes(slope = FF_quantile, intercept = 0, 
                    linetype = 'dashed', color = quantiles))+
    facet_grid(~ Delay_type, scales = 'free')+
    theme(legend.position=legend)+
    ggtitle(paste('Segment:',seg))
  ggplotly(ff)
}
```


### Segment 1

```{r free flow plot seg1, fig.width = 11,echo = FALSE, message = FALSE}

free_flow_plot(1, 'none')
```



### Segment 2

```{r free flow plot seg 2, fig.width = 11,echo = FALSE, message = FALSE}

free_flow_plot(2, 'none')
```

### Segment 3

```{r free flow plot seg 3, fig.width = 11,echo = FALSE, message = FALSE}

free_flow_plot(3, 'none')
```

### Segment 4

```{r free flow plot seg 4, fig.width = 11,echo = FALSE, message = FALSE}

free_flow_plot(4, 'none')
```

### Segment 5

```{r free flow plot seg 5, fig.width = 11,echo = FALSE, message = FALSE}

free_flow_plot(5, 'none')
```


### Segment 6

```{r free flow plot seg 6, fig.width = 11,echo = FALSE, message = FALSE}

free_flow_plot(6, 'none')
```

### Segment 7

```{r free flow plot seg 7, fig.width = 11,echo = FALSE, message = FALSE}

free_flow_plot(7, 'none')
```

### Segment 8

```{r free flow plot seg 8, fig.width = 11,echo = FALSE, message = FALSE}

free_flow_plot(8, 'none')

```

### Segment 9

```{r free flow plot seg 9, fig.width = 11,echo = FALSE, message = FALSE}
free_flow_plot(9, 'none')
```

## DENSITY vs TT {.tabset .tabset-fade}

A look at the Density vs travel time plots. A generic smooting function has been added. 

```{r dens vs tt plot, include=FALSE}

dens_tti_plot <- function(seg,legend = '', sp = 1){
  tt <- ggplot()+
    geom_point(data=Rel_bin[Rel_bin$Segment == seg,],
               aes(x= Density_bin,y = TT_quantile, color= quantiles))+
    geom_smooth(data=Rel_bin[Rel_bin$Segment == seg,],
                aes(x= Density_bin,y = TT_quantile, color= quantiles),span=sp,se=F)+
    facet_grid(~Delay_type, scales = 'free')+
    theme(legend.position=legend)+
    ggtitle(paste('Segment:',seg))
  ggplotly(tt)
}
```

```{r save pre filter data, include=FALSE}
Rel_bin_preFilter <- Rel_bin
# Rel_bin <- Rel_bin_preFilter
```

### Segment 1

```{r seg1 filter}
Rel_bin <- Rel_bin %>%
  filter(!(Segment == 1 & Density_bin > 199)) %>%
  filter(!(Segment == 1 & Delay_type == 'None' & Density_bin > 100)) %>%
  filter(!(Segment == 1 & Delay_type == 'Weather' & Density_bin > 89)) %>%
  filter(!(Segment == 1 & Delay_type == 'Crash' & Density_bin > 45))

```

```{r Density vs TT seg1, fig.width = 11, echo = FALSE, message = FALSE}
dens_tti_plot(1,'',1)
```

### Segment 2

```{r seg2 filter}
Rel_bin <- Rel_bin %>%
  filter(!(Segment == 2 & Delay_type == 'Crash' & Density_bin > 100)) %>%
  filter(!(Segment == 2 & Delay_type == 'Weather' & Density_bin > 81))
```

```{r Density vs TT seg 2, fig.width = 11,echo = FALSE, message = FALSE}

dens_tti_plot(2,'none',1)
```

### Segment 3

```{r seg3 filter}
Rel_bin <- Rel_bin %>%
  filter(!(Segment == 3 & Delay_type == 'None' & Density_bin > 90)) %>%
  filter(!(Segment == 3 & Delay_type == 'Crash' & Density_bin > 101)) 
```

```{r Density vs TT seg 3, fig.width = 11,echo = FALSE, message = FALSE}
dens_tti_plot(3,'none',1)
```

### Segment 4

```{r seg4 filter}
Rel_bin <- Rel_bin %>%
  filter(!(Segment == 4 & Delay_type == 'None' & Density_bin > 59)) %>%
  filter(!(Segment == 4 & Delay_type == 'None' & Density_bin == 50)) %>%
  filter(!(Segment == 4 & Delay_type == 'Weather' & Density_bin > 40)) %>%
  filter(!(Segment == 4 & Delay_type == 'Crash' & Density_bin == 48)) 

```

```{r Density vs TT seg 4, fig.width = 11,echo = FALSE, message = FALSE}

dens_tti_plot(4,'none',1)
```

### Segment 5

```{r Density vs TT seg 5, fig.width = 11,echo = FALSE, message = FALSE}
dens_tti_plot(5,'none',1)
```

### Segment 6

```{r seg6 filter}
Rel_bin <- Rel_bin %>%
  filter(!(Segment == 6 & Density_bin > 59))
```

```{r Density vs TT seg6, fig.width = 11,echo = FALSE, message = FALSE}
dens_tti_plot(6,'',1)
```

### Segment 7

```{r seg7 filter}
Rel_bin <- Rel_bin %>%
  filter(!(Segment == 7 & Delay_type == 'Weather' & Density_bin > 59)) %>%
  filter(!(Segment == 7 & Delay_type == 'None' & Density_bin > 46)) %>%
  filter(!(Segment == 7 & Delay_type == 'Crash' & Density_bin > 46))

```

```{r Density vs TT seg  7, fig.width = 11,echo = FALSE, message = FALSE}

dens_tti_plot(7,'none',0.75)
```

### Segment 8

```{r seg8 filter}
Rel_bin <- Rel_bin %>%
  filter(!(Segment == 8 & Delay_type == 'None' & Density_bin > 80)) %>%
  filter(!(Segment == 8 & Delay_type == 'Crash' & Density_bin == 80))

```

```{r Density vs TT seg 8, fig.width = 11,echo = FALSE, message = FALSE}
dens_tti_plot(8,'none',1)
```



### Segment 9

```{r seg9 filter}
Rel_bin <- Rel_bin %>%
  filter(!(Segment == 9 & Delay_type == 'Weather' & Density_bin > 40)) %>%
  filter(!(Segment == 9 & Delay_type == 'Weather' & Density_bin == 38)) %>%
  filter(!(Segment == 9 & Delay_type == 'None' & Density_bin > 80)) %>%
  filter(!(Segment == 9 & Delay_type == 'Crash' & Density_bin > 38))


```

```{r Density vs TT seg9, fig.width = 11,echo = FALSE, message = FALSE}

dens_tti_plot(9,'none',1)
```


## DENSITY vs FLOW {.tabset .tabset-fade}

Below are the Flow vs Density plots for each condition. 

```{r load density flow manual table, include = FALSE}

dens_flow_tab <- read.csv('./Future/congestion density flow table.csv')
dens_flow_tab <- dcast(dens_flow_tab, Segment + quantiles + Delay_type + Axis ~ Measure, value.var = 'Value') %>%
  select(Density_cong = Density, Flow_cong = Flow, everything())
head(dens_flow_tab)
```

```{r dens_flow_plot, include=FALSE}

dens_flow_plot <- function(seg,legend='', bin = NA){
  
  dens_flow_data <- filter(dens_flow_tab, Segment == seg)
  
  flow_dens <- 
  if(is.na(bin)){
    dat <- Rel_p[Rel_p$Segment == seg,]
    plot_x <- 'Dens'
    plot_y <- 'Hourly_Flow'
    q <- 'Quantile_u'
  } else {
    dat <- Rel_bin[Rel_bin$Segment == seg,]
    plot_x <- 'Density_bin'
    plot_y <- 'Flow'
    q <- 'quantiles'
  }
  
  tt <- ggplot()+
    geom_point(data=dat, aes_string(x= plot_x,y = plot_y, color= q))+
    geom_segment(data = dens_flow_data,
                 aes(x = Density_cong, y = Axis,
                     xend = Density_cong, yend = Flow_cong,
                     color = quantiles), linetype = 'dashed') +
    geom_segment(data = dens_flow_data,
                 aes(x = Axis, y = Flow_cong,
                     xend = Density_cong, yend = Flow_cong,
                     color = quantiles), linetype = 'dashed') +
    # geom_smooth(span=0.75,se=F)+
    facet_grid(~Delay_type, scales = 'free')+
    # scale_y_continuous(minor_breaks = seq(0, 4000,50), breaks = seq(0,4000,100))+
    # scale_x_continuous(minor_breaks = seq(0,500,5), breaks = seq(0,500,10))+
    theme(legend.position=legend)+
    ggtitle(paste('Segment:',seg))
  ggplotly(tt)
  
}
```

Vertical and horizontal dashed lines indicate the Congested Density and Flow points. This values were manually determined by visually inspecting these plots. 

### Segment 1

```{r Density vs Flow seg1, fig.width = 12,echo = FALSE, message = FALSE}

dens_flow_plot(1,'', bin = TRUE)
```


### Segment 2

```{r Density vs Flow seg2, fig.width = 11,echo = FALSE, message = FALSE}

dens_flow_plot(2,'none', bin = TRUE)
```

```{r filter segment 2}
```


### Segment 3

```{r Density vs Flow seg3, fig.width = 11,echo = FALSE, message = FALSE}

dens_flow_plot(3,'', bin = TRUE)
```

```{r filter segment 3}
```

### Segment 4

```{r Density vs Flow seg4, fig.width = 11,echo = FALSE, message = FALSE}

dens_flow_plot(4,'none', bin = TRUE)
```

```{r filter segment 4}

```

### Segment 5

```{r Density vs Flow seg5, fig.width = 11,echo = FALSE, message = FALSE}
dens_flow_plot(5,'none', bin = TRUE)
```

```{r filter segment 5}
```

### Segment 6

```{r filter segment 6}

```

```{r Density vs Flow seg6, fig.width = 11,echo = FALSE, message = FALSE}

dens_flow_plot(6,'', bin = TRUE)
```

### Segment 7

```{r Density vs Flow seg7, fig.width = 11,echo = FALSE, message = FALSE}

dens_flow_plot(7,'', bin = TRUE)
```

```{r filter segment 7}

```

### Segment 8

```{r Density vs Flow seg8, fig.width = 11,echo = FALSE, message = FALSE}
dens_flow_plot(8,'', bin = TRUE)
```

```{r filter segment 8}

```

### Segment 9

```{r filter segment 9, echo = FALSE, message = FALSE}
```

```{r Density vs Flow seg9, fig.width = 11,echo = FALSE, message = FALSE}

dens_flow_plot(9,'', bin = TRUE)
```




## FLOW vs TT {.tabset .tabset-fade}


```{r dens_flow_plot, include=FALSE}

TT_flow_plot <- function(seg,legend='', bin = NA){
  
  TT_flow_data <- filter(dens_flow_tab, Segment == seg)
  
  flow_dens <- 
  if(is.na(bin)){
    dat <- Rel_p[Rel_p$Segment == seg,]
    plot_x <- 'TT_mean'
    plot_y <- 'Hourly_Flow'
    q <- 'Quantile_l'
  } else {
    dat <- Rel_bin[Rel_bin$Segment == seg,]
    plot_x <- 'TT_quantile'
    plot_y <- 'Flow'
    q <- 'quantiles'
  }
  
  tt <- ggplot()+
    geom_point(data=dat, aes_string(x= plot_x,y = plot_y, color= q))+
    # geom_smooth(span=0.75,se=F)+
    facet_grid(~Delay_type, scales = 'free')+
    # scale_y_continuous(minor_breaks = seq(0, 4000,50), breaks = seq(0,4000,100))+
    # scale_x_continuous(minor_breaks = seq(0,500,5), breaks = seq(0,500,10))+
    theme(legend.position=legend)+
    ggtitle(paste('Segment:',seg))
  ggplotly(tt)
  
}
```

### Segment 3

```{r TT_flow seg6, fig.width = 11, echo = FALSE, message = FALSE}
TT_flow_plot(3,'',bin = NA)

```


### Segment 6

```{r TT_flow seg6, fig.width = 11, echo = FALSE, message = FALSE}
TT_flow_plot(6,'',bin = NA)

group_by(Rel_p, Segment) %>% summarise(max = sd(Dens))
```


## DEMAND

```{r R^2, include=FALSE}

some_data <- Rel_bin %>%
  filter(Segment == 2, Delay_type == 'None', quantiles == '75%') %>%
  select(Density_bin, TT_quantile, Speed, Flow)  %>%
  arrange( Density_bin) %>%
  mutate(Index = seq(1:length(Flow)))

df <- list()
for (i in 1:length(some_data$Density_bin)){
  mod <- lm(data = some_data[1:i,],Flow ~ Density_bin)
  df[i] <- (summary(mod)$adj.r.squared)
}
df <- unlist(df)

some_data$R_sq <- df

g <- ggplot(some_data,aes(x= Density_bin, y = Flow, color = R_sq, text = R_sq)) +
  geom_point() +
  geom_smooth(span=0.75,se=F) 
ggplotly(g, tooltip = 'text')
  
```

Calculate Demand and DC.

```{r calculate Demand}

Rel_bin <- merge(Rel_bin, dens_flow_tab,
                 by = c('Delay_type','quantiles', 'Segment')) %>%
  mutate(Demand = ifelse(Density_bin <= Density_cong, Flow,
                         ifelse(Density_bin >= Density_cong & Flow <= Flow_cong,
                                Flow_cong + (Flow_cong - Flow),
                                Flow)),
         DC = Demand/Flow_cong) 

```

## TTI vs DEMAND {.tabset .tabset-fade}

A look at the Density vs travel time plots. A generic smooting function has been added. 

```{r TTI vs Demand plot, include=FALSE}

demand_tti_plot <- function(seg,legend = '', sp = 1){
  tt <- ggplot()+
    geom_point(data=Rel_bin[Rel_bin$Segment == seg,],
               aes(x= Demand,y = TTI, color= quantiles))+
    # geom_smooth(data=Rel_bin[Rel_bin$Segment == seg,],
    #             aes(x= Demand,y = TTI, color= quantiles),span=sp,se=F)+
    facet_grid(~Delay_type, scales = 'free')+
    theme(legend.position=legend)+
    ggtitle(paste('Segment:',seg))
  ggplotly(tt)
}
```



### Segment 1

```{r TTI vs Demand seg1, fig.width = 12,echo = FALSE, message = FALSE}

demand_tti_plot(1,'',1)
```

### Segment 2

```{r TTI vs Demand seg2, fig.width = 11,echo = FALSE, message = FALSE}

demand_tti_plot(2,'',1)
```


### Segment 3

```{r TTI vs Demand seg3, fig.width = 11,echo = FALSE, message = FALSE}

demand_tti_plot(3,'',1)
```

### Segment 4

```{r TTI vs Demand seg4, fig.width = 11,echo = FALSE, message = FALSE}

demand_tti_plot(4,'',1)
```


### Segment 5

```{r TTI vs Demand seg5, fig.width = 11,echo = FALSE, message = FALSE}
demand_tti_plot(5,'',1)
```


### Segment 6

```{r TTI vs Demand seg6, fig.width = 11,echo = FALSE, message = FALSE}

demand_tti_plot(6,'',1)
```

### Segment 7

```{r TTI vs Demand seg7, fig.width = 11,echo = FALSE, message = FALSE}
demand_tti_plot(7,'',1)
```

### Segment 8

```{r TTI vs Demand seg8, fig.width = 11,echo = FALSE, message = FALSE}
demand_tti_plot(8,'',1)
```

### Segment 9

```{r TTI vs Demand seg9, fig.width = 11,echo = FALSE, message = FALSE}

demand_tti_plot(9,'',1)
```

## Prediction


The below code is used to develop the model based on the relationship between TTI and DC. 

```{r develop model, message = TRUE}

q <-     5
br <-    0.95
q <- paste(q, '%', sep ='')

sample_data <- Rel_p %>%
  filter(Segment == 3, Delay_type == 'Crash', Quantile_l == q, !is.na(DC)) %>%
  select(DC, TTI)


# sample_data <- Rel_bin %>%
#   filter(Segment == 3, Delay_type == 'Crash', quantiles == q, !is.na(DC)) %>%
#   select(DC, TTI)

formulaExp <- as.formula(TTI ~(DC <= br) + (DC > br) * ( mu * (DC ^ b)))
b <- 3
mu <- 1.5

sample_nls <- nls(formulaExp, data = sample_data, start = list(mu = 1.5, b = 3),
                  nls.control(maxiter = 50))
plotfit(sample_nls, smooth = TRUE)

predict(sample_nls, data.frame(DC = 1.4))
rm(br)
```

```{r create prediction model, include = FALSE}

func_exp <- function(x) {
  nls(
    TTI ~(DC <= br) + (DC > br) * ( mu * (DC ^ b)),
    start = list(mu = 1.5, b = 3),
    data = x,
    nls.control(maxiter = 50))
}

breaks <- read.csv('./Future/model_breaks.csv')
Rel_bin <- merge(Rel_bin, breaks)

model_nls <- Rel_p %>%
  nest(-Segment, -Delay_type, -Quantile_l) %>%
  filter(Segment %in% c(1:4,6:8),
         Delay_type %in% c('None', 'Crash','Weather'),
         Quantile_l %in% c('5%','10%','25%','50%','75%','90%','95%')) %>%
  mutate(fit = purrr::map(data, func_exp))

```


```{r join model to table predict on DC, include = FALSE}
table(duplicated(Rel_bin[,1:5]))

Rel_p <- filter(Rel, Segment %in% c(1:4,6:8))

Rel_q <- Rel_p %>% 
  select(Segment, Delay_type, Density_bin, TT_q = TT_mean, Index) %>%
  data.table()

TT_q_table <- data.table(Rel_bin) %>% 
  select(Segment, Delay_type, Density_bin,
         TT_q = TT_quantile, quantiles,
         FF_quantile, Flow_cong, Density_cong, br) %>% data.table()

setkey(TT_q_table, NULL)

setkey(TT_q_table, Segment, Delay_type, Density_bin, TT_q)

join_TT <- TT_q_table[Rel_q, roll = -Inf, .(TT_quantile_u = x.TT_q,
                                            TT_mean = i.TT_q,
                                            Delay_type = Delay_type,
                                            Index = Index,
                                            Segment = Segment,
                                            Density_bin = Density_bin,
                                            FF_u = FF_quantile,
                                            Quantile_u = quantiles,
                                            Flow_cong_u = Flow_cong,
                                            Density_cong_u = Density_cong)] %>%
  select(Segment, Delay_type, Density_bin, TT_mean, 
         TT_quantile_u, Quantile_u, Flow_cong_u, Density_cong_u, FF_u, Index) %>%
  data.table()

join_TT <- TT_q_table[join_TT, roll = T, .(TT_quantile_l = x.TT_q,
                                           TT_quantile_u = i.TT_quantile_u,
                                           TT_mean = TT_mean,
                                           FF_l = FF_quantile,
                                           FF_u = FF_u,
                                           Delay_type = Delay_type,
                                           Quantile_u = Quantile_u,
                                           Quantile_l = quantiles,
                                           Flow_cong_u = Flow_cong_u,
                                           Density_cong_u = Density_cong_u,
                                           Flow_cong_l = Flow_cong,
                                           Density_cong_l = Density_cong,
                                           Index = Index,
                                           br = br,
                                           Segment = Segment,
                                           Density_bin = Density_bin)]


head(join_TT)
join_TT <- join_TT[!duplicated(join_TT$Index),]

Rel_p <- merge(Rel_p, 
                 join_TT[,c('Index','TT_quantile_u', 'TT_quantile_l',
                            'Quantile_u','Quantile_l','Flow_cong_u','Density_cong_u','FF_u',
                            'Flow_cong_l','Density_cong_l','FF_l','br')],
                 by = 'Index', all.x=TRUE)

table(is.na(Rel_p$Flow_cong))

Rel_p <- Rel_p %>%
  mutate(TT_quantile_l = ifelse(is.na(TT_quantile_l),
                                TT_quantile_u, 
                                TT_quantile_l),
         TT_quantile_u = ifelse(is.na(TT_quantile_u), 
                                TT_quantile_l, 
                                TT_quantile_u),
         Diff = ifelse(TT_quantile_u == TT_quantile_l,
                       0,
                       (TT_mean-TT_quantile_l)/(TT_quantile_u - TT_quantile_l)),
         Density_cong = ifelse(is.na(Density_cong_l),
                               Density_cong_u, 
                               ifelse(is.na(Density_cong_u),
                                      Density_cong_l,
                                      Density_cong_l + (Density_cong_u - Density_cong_l) * Diff)),
         Flow_cong = ifelse(is.na(Flow_cong_l),
                            Flow_cong_u,
                            ifelse(is.na(Flow_cong_u),
                                   Flow_cong_l,
                                   Flow_cong_l + (Flow_cong_u - Flow_cong_l) * Diff)),
         Demand = ifelse(Density_bin <= Density_cong, Hourly_Flow, 2 * Flow_cong - Hourly_Flow),
         DC = Demand / Flow_cong,
         FF = ifelse(is.na(FF_l),
                     FF_u,
                     ifelse(is.na(FF_u),
                            FF_l,
                            FF_l + (FF_u - FF_l) * Diff)),
         TTI = TT_mean / (Length/FF * 60))
```


```{r}
Rel_p_u <- Rel_p %>%
  select(Segment, Delay_type, Quantiles = Quantile_u, DC, Index, br) %>%
  nest(-Segment, -Delay_type, -Quantiles) %>%
  merge(model_nls %>% select(Segment, Delay_type, Quantiles = quantiles, fit)) %>%
  as.tibble() %>%
  mutate(pred = map2(fit,data,predict)) %>%
  as.tibble() %>%
  unnest(data,pred)

Rel_p_l <- Rel_p %>% 
  select(Segment, Delay_type, Quantiles = Quantile_l, DC, Index, br) %>%
  nest(-Segment, -Delay_type, -Quantiles) %>%
  merge(model_nls %>% select(Segment, Delay_type, Quantiles = quantiles, fit)) %>%
  as.tibble() %>%
  mutate(pred = map2(fit,data,predict)) %>%
  as.tibble() %>%
  unnest(data,pred)

Rel_p <- merge(Rel_p, select(Rel_p_u, Index, pred_u = pred), all.x = TRUE) %>%
  merge(select(Rel_p_l, Index, pred_l = pred), all.x = TRUE) %>%
  mutate(pred_final = ifelse(is.na(pred_l), 
                             pred_u,
                             ifelse(is.na(pred_u),
                                    pred_l,
                                    pred_l + (pred_u - pred_l) * Diff)),
         Error = abs(pred_final - TTI))

rm(Rel_p_l, Rel_p_u, join_TT, Rel_q, TT_q_table)

```

## Prediction Results {.tabset .tabset-fade}

```{r prediction plotting fuction, include = FALSE}
plot_predict <- function(Seg){
  
  pr <- ggplot(filter(Rel_p,Segment == Seg), aes(x= TTI,y=pred_final, color = Quantile_u))+
    geom_point() +
    geom_abline(intercept = 0, slope = 1, linetype = 'dashed', color = 'red') +
    # scale_x_continuous(breaks = c(1,2,3,4,5))+
    # scale_y_continuous(breaks = c(1,2,3,4,5,6))+
    facet_grid(~Delay_type)
  ggplotly(pr)
}


 pr <- ggplot(filter(Rel_p,Segment == 1), aes(x= TTI,y=pred_final, color = Quantile_u))+
    geom_point() +
    geom_abline(intercept = 0, slope = 1, linetype = 'dashed', color = 'red') +
    # scale_x_continuous(breaks = c(1,2,3,4,5))+
    # scale_y_continuous(breaks = c(1,2,3,4,5,6))+
    facet_grid(~Delay_type)
  ggplotly(pr)
```


### Prediction Segment 1

```{r plot predict seg1, fig.width=12}
plot_predict(1)
```

### Prediction Segment 2

```{r plot predict seg2, fig.width=12}
plot_predict(2)
```

### Prediction Segment 3

```{r plot predict seg3, fig.width=12}
plot_predict(3)
```


### Prediction Segment 4

```{r plot predict seg4, fig.width=12}
plot_predict(4)
```

### Prediction Segment 5

```{r plot predict seg5, fig.width=12}
plot_predict(5)
```

### Prediction Segment 6

```{r plot predict seg6, fig.width=12}
plot_predict(6)
```

### Prediction Segment 7

```{r plot predict seg7, fig.width=12}
plot_predict(7)
```

### Prediction Segment 8

```{r plot predict seg8, fig.width=12}
plot_predict(8)
```

### Prediction Segment 9
```{r plot predict seg9, fig.width=12}
plot_predict(9)
```

## Analyse Prediction Results {.tabset .tabset-fade}

### SEGMENT 3

```{r SEGMENT 3 RESULTS}

segment3 <- Rel_p %>%
  filter(Segment == 3,
         TTI > 2.9 & TTI < 3.1
         # Error < 0.5
         # is.na(Quantile_u)
         ) %>%
  arrange(desc(Error))

model_3 <- filter(model_nls, Segment == 3,
                  Delay_type == 'Crash',
                  quantiles == '95%')

```



### SEGMENT 6

```{r SEGMENT 6 RESULTS}

segment6 <- Rel_p %>%
  filter(Segment == 6,
         TTI > 1.25 & TTI < 1.3,
         Error > 0.25,
         # is.na(Quantile_u)
         ) %>%
  arrange(desc(Error))

```

### SEGMENT 7

```{r SEGMENT 7 RESULTS}

segment7 <- Rel_p %>%
  filter(Segment == 7
         # TTI > 1.25 & TTI < 1.3,
         # Error < 0.5
         # is.na(Quantile_u)
         ) %>%
  arrange(desc(Error))

```


## HEATMAP {.tabset .tabset-fade}


```{r heatmap,include = FALSE, message = FALSE}

TT_heat <-function(data,seg, model){ 
  
  heat <- data %>%
    filter(Segment == seg) %>% 
    select(DateTime, TT_mean, Length, pred = pred_final) %>% 
    mutate(HourMin = format(DateTime, '%H:%M'),
           YearDate = as.POSIXct(format(DateTime, '%Y-%m-%d')),
           mod = model,
           TTI = ifelse(mod == TRUE,
                        pred,
                        TT_mean/(Length/60 * 60)),
           TTI_Cat = factor(ifelse(TTI > 4.0,'>4.0 TTI',
                                   ifelse(TTI <= 4.0 & TTI > 3.5,
                                          '3.5 TTI - 4.0 TTI',
                                          ifelse(TTI <= 3.5 & TTI > 3.0,
                                                 '3.0 TTI - 3.5 TTI',
                                                 ifelse(TTI <= 3.0 & TTI > 2.5,
                                                        '2.5 TTI - 3.0 TTI',
                                                        ifelse(TTI <= 2.5 & TTI > 2.0,
                                                               '2.0 TTI - 2.5 TTI',
                                                               ifelse(TTI <= 2.0 & TTI > 1.5,
                                                                      '1.5 TTI - 2.0 TTI',
                                                                      ifelse(TTI <= 1.5 & TTI > 1.25,
                                                                             '45 mph TT - 1.5 TTI',
                                                                             ifelse(TTI <= 1.25 & TTI > 1.0 ,
                                                                                    'Speed Limit TT - 45 mph TT',
                                                                                    ifelse(TTI <= 1.0 ,
                                                                                           '<Speed Limit TT', NA))))))))),
                            levels = (c('>4.0 TTI',
                                        '3.5 TTI - 4.0 TTI',
                                        '3.0 TTI - 3.5 TTI',
                                        '2.5 TTI - 3.0 TTI',
                                        '2.0 TTI - 2.5 TTI',
                                        '1.5 TTI - 2.0 TTI',
                                        '45 mph TT - 1.5 TTI',
                                        'Speed Limit TT - 45 mph TT',
                                        '<Speed Limit TT')))) 
  
  
library(RColorBrewer)
myColors <- colors()[c(24,30,507,552,59,53,652,256,258)]
names(myColors) <- levels(heat$TTI_Cat)
colScale <- scale_colour_manual(name = "TTI_Cat",values = myColors)
fillScale <- scale_fill_manual(name = "TTI_Cat",values = myColors)
break_axis <- c('06:00','09:00','12:00','15:00','18:00','21:00')

predicted_TF <- ifelse(model == TRUE,'predicted values','measured values')

g <- ggplot(heat) +
  geom_tile(aes(x=YearDate,y=HourMin,color = TTI_Cat, fill = TTI_Cat))  +
  theme_tufte(base_size = 15) +
  scale_y_discrete(breaks = break_axis) +
  colScale + fillScale +
  ggtitle(paste('Segment', seg, 'TTI Heatmap','-',predicted_TF))
return(g)
}
```

### SEGMENT 1

```{r heatmap seg1, fig.width=12}

TT_heat(Rel_p,1, model = FALSE)

TT_heat(Rel_p,1, model = TRUE)

```

### SEGMENT 2

```{r heatmap seg2, fig.width=12}

TT_heat(Rel_p,2, FALSE)

TT_heat(Rel_p,2, TRUE)

```

### SEGMENT 3

```{r heatmap seg3, fig.width=12}

TT_heat(Rel_p,3, FALSE)

TT_heat(Rel_p,3, TRUE)

```

### SEGMENT 4

```{r heatmap seg4, fig.width=12}

TT_heat(Rel_p,4, FALSE)

TT_heat(Rel_p,4, TRUE)

```

### SEGMENT 5

```{r heatmap seg5, fig.width=12}

TT_heat(Rel_p,5, FALSE)

TT_heat(Rel_p,5, TRUE)

```

### SEGMENT 6

```{r heatmap seg6, fig.width=12}

TT_heat(Rel_p,6, FALSE)

TT_heat(Rel_p,6, TRUE)

```

### SEGMENT 7

```{r heatmap seg7, fig.width=12}

TT_heat(Rel_p,7, FALSE)

TT_heat(Rel_p,7, TRUE)

```

### SEGMENT 8

```{r heatmap seg8, fig.width=12}

TT_heat(Rel_p,8, FALSE)

TT_heat(Rel_p,8, TRUE)

```

### SEGMENT 9

```{r heatmap seg9, fig.width=12}

TT_heat(Rel_p,9, FALSE)

TT_heat(Rel_p,9, TRUE)

```
